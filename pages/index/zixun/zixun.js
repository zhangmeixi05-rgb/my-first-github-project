const app = getApp();

Page({
  // Êñ∞Â¢ûÊú¨Âú∞Áü•ËØÜÂ∫ì
  localKnowledgeBase: {
    // 1. Âø´‰πêÊÉÖÁª™
    "happy": [
      ["ÂºÄÂøÉ|È´òÂÖ¥|Âø´‰πê|ÊÑâÂø´|Âπ∏Á¶è|ÂìàÂìàÂìà", 
       "üòä Ê£ÄÊµãÂà∞ÁßØÊûÅÊÉÖÁª™ÔºÅ‰øùÊåÅÂ•ΩÂøÉÊÉÖÂèØ‰ª•Ôºö\n\n" +
       "‚ú® Âø´‰πêÊîæÂ§ßÊ≥ïÔºö\n" +
       "1. ËÆ∞ÂΩïÊ≠§ÂàªÊÑüÂèóÔºàÂª∫ËÆÆÂÜôÊó•ËÆ∞Ôºâ\n" +
       "2. ‰∏é‰∫≤ÂèãÂàÜ‰∫´Âø´‰πêÔºàÂø´‰πê‰ºö‰º†ÊüìÔºâ\n" +
       "3. ÂÅö‰∫õÂàõÈÄ†ÊÄßÊ¥ªÂä®ÔºàÁªòÁîª/ÂÜô‰ΩúÁ≠âÔºâ"],
       
      ["Á¨ë|ÂìàÂìà|ÂòøÂòø|ÂòªÂòª", 
       "ü§ó Á¨ëÂÆπÊòØÊúÄÂ•ΩÁöÑÊÉÖÁª™Ë∞ÉËäÇÂâÇÔºÅ\n\n" +
       "üí° Â∞èÂª∫ËÆÆÔºö\n" +
       "‚Ä¢ ÁúãÂñúÂâßÁâá/ÊêûÁ¨ëËßÜÈ¢ë\n" +
       "‚Ä¢ ÂõûÂøÜÂºÄÂøÉÂæÄ‰∫ã\n" +
       "‚Ä¢ ÂÅöÈ¨ºËÑ∏Ëá™Êãç"]
    ],
  
    // 2. ÂéãÂäõ/ÁÑ¶Ëôë
    "stress": [
      ["ÂéãÂäõÂ§ß|ÂéãÂäõÂ•ΩÂ§ß|Âñò‰∏çËøáÊ∞î|ÂéãÂæóÊÖå", 
       "üßò ÂéãÂäõÁÆ°ÁêÜ‰∏âÊ≠•Ê≥ïÔºö\n\n" +
       "1. ÊöÇÂÅúÂëºÂê∏Ê≥ïÔºàÂê∏Ê∞î4Áßí‚ÜíÂ±èÊÅØ4Áßí‚ÜíÂëºÊ∞î6ÁßíÔºâ\n" +
       "2. ÂéãÂäõÊ∫êÂàÜÁ±ªÊ≥ïÔºàÂå∫ÂàÜÂèØÊéß/‰∏çÂèØÊéßÂõ†Á¥†Ôºâ\n" +
       "3. ÂæÆÂ∞èË°åÂä®Ê≥ïÔºà‰ªéÊúÄÂ∞èÂèØË°åÂä®‰ΩúÂºÄÂßãÔºâ"],
       
      ["ÁÑ¶Ëôë|ÂøÉÊÖå|ÂùêÁ´ã‰∏çÂÆâ", 
       "üåø ÁÑ¶ËôëÁºìËß£ÊñπÊ°àÔºö\n\n" +
       "‚Ä¢ 5-4-3-2-1 grounding ÊäÄÊúØÔºö\n" +
       "  ÊâæÂá∫5‰∏™ÂèØËßÅÁâ©‰Ωì‚Üí4ÁßçÂèØËß¶Êë∏ÊùêË¥®‚Üí3ÁßçÁéØÂ¢ÉÂ£∞‚Üí2ÁßçÊ∞îÂë≥‚Üí1ÁßçÂë≥ÈÅì\n" +
       "‚Ä¢ Ê∏êËøõÂºèËÇåËÇâÊîæÊùæÔºà‰ªéËÑöË∂æÂà∞Â§¥ÁöÆÈÄê‰∏™ÈÉ®‰ΩçÊî∂Á¥ß‚ÜíÊîæÊùæÔºâ"]
    ],
  
    // 3. ÊäëÈÉÅ/‰ΩéËêΩ
    "depression": [
      ["ÊäëÈÉÅ|‰ΩéËêΩ|ÈÉÅÈó∑|Ê≤°ÊÑèÊÄù|Ê¥ªÁùÄÊ≤°ÊÑèÊÄù", 
       "üåß ÊÇ®Áé∞Âú®ÁöÑÊÑüÂèóÂæàÈáçË¶ÅÔºåÂª∫ËÆÆÔºö\n\n" +
       "1. ËÅîÁ≥ªÂèØ‰ø°ËµñÁöÑ‰∫∫Èù¢ÂØπÈù¢‰∫§Ë∞à\n" +
       "2. ËøõË°åÊúÄ‰ΩéÂº∫Â∫¶ËøêÂä®ÔºàÂ¶ÇÊï£Ê≠•10ÂàÜÈíüÔºâ\n" +
       "3. È¢ÑÁ∫¶‰∏ì‰∏öÂøÉÁêÜÂí®ËØ¢Â∏à\n\n" +
       "‚òé ÂøÉÁêÜÊè¥Âä©ÁÉ≠Á∫øÔºö\n" +
       "Âåó‰∫¨24Â∞èÊó∂Ôºö010-82951332\n" +
       "‰∏äÊµ∑ÂøÉÁêÜÁÉ≠Á∫øÔºö021-12320-5"],
       
      ["ÊÉ≥Âì≠|ÈöæÂèó|Â•ΩÈöæËøá", 
       "ü§ç ÊÉÖÁª™ÈáäÊîæÊòØÂÅ•Â∫∑ÁöÑÔºö\n\n" +
       "‚Ä¢ ÂáÜÂ§áÂÆâÂÖ®ÁéØÂ¢ÉÔºàËàíÈÄÇÁ©∫Èó¥+Á∫∏Â∑æ+Ê∏©Ê∞¥Ôºâ\n" +
       "‚Ä¢ ËÆæÁΩÆËÆ°Êó∂Âô®ÔºàÂÖÅËÆ∏Ëá™Â∑±Âì≠5-10ÂàÜÈíüÔºâ\n" +
       "‚Ä¢ Âì≠ÂêéË°•ÂÖÖÁ≥ñÂàÜÔºàÂ∑ßÂÖãÂäõ/È¶ôËïâÁ≠âÔºâ"]
    ],
  
    // 4. ÊÑ§ÊÄí/ÁÉ¶Ë∫Å
    "anger": [
      ["ÁîüÊ∞î|ÊÑ§ÊÄí|Ê∞îÊ≠ª|ÁÅ´Â§ß|ÁÉ¶Ê≠ª‰∫Ü", 
       "üî• ÊÑ§ÊÄíËÉΩÈáèËΩ¨Êç¢Ê≥ïÔºö\n\n" +
       "1. Áâ©ÁêÜÈáäÊîæÔºö\n" +
       "   ‚Ä¢ ÊíïÂ∫üÁ∫∏\n" +
       "   ‚Ä¢ Êç∂ÊâìÊûïÂ§¥\n" +
       "   ‚Ä¢ Âø´Ë∑ë30Áßí\n" +
       "2. ËÆ§Áü•ÈáçÊûÑÔºö\n" +
       "   ‚Ä¢ Ëá™ÈóÆ„ÄåËøô‰∫ã3Âπ¥ÂêéËøòÈáçË¶ÅÂêóÔºü„Äç"],
       
      ["ÁÉ¶Ë∫Å|ÊòìÊÄí|Áúã‰ªÄ‰πàÈÉΩ‰∏çÈ°∫Áúº", 
       "üå™ ÊÉÖÁª™ÈôçÊ∏©ÊäÄÂ∑ßÔºö\n\n" +
       "‚Ä¢ ÈôçÊ∏©Âà∫ÊøÄÔºöÂÜ∑Ê∞¥Ê¥óËÑ∏/Âê´ÂÜ∞Âùó\n" +
       "‚Ä¢ ÂóÖËßâË∞ÉËäÇÔºöÈóªËñÑËç∑Á≤æÊ≤π\n" +
       "‚Ä¢ Âª∂ËøüÂèçÂ∫îÔºöÊï∞Âà∞10ÂÜçËØ¥ËØù"]
    ],
  
    // 5. Â≠§Áã¨/ÂØÇÂØû
    "lonely": [
      ["Â≠§Áã¨|Â≠§Âçï|Ê≤°‰∫∫ÁêÜËß£|Áã¨Êù•Áã¨ÂæÄ", 
       "üåå Â≠§Áã¨ÊÑüËΩ¨ÂåñÊåáÂçóÔºö\n\n" +
       "1. Á∫ø‰∏äÁ§æÁæ§Ôºö\n" +
       "   ‚Ä¢ Ë±ÜÁì£Â∞èÁªÑÔºàÊêúÁ¥¢„ÄåÂêåÂ•Ω„ÄçÔºâ\n" +
       "   ‚Ä¢ ÂøÉÁêÜÁ±ªÊí≠ÂÆ¢ÁïôË®ÄÂå∫\n" +
       "2. Á∫ø‰∏ãÊé•Ëß¶Ôºö\n" +
       "   ‚Ä¢ ÂèÇÂä†ËØª‰π¶‰ºö/ÂÖ¥Ë∂£Áè≠\n" +
       "   ‚Ä¢ ÂÆöÊúüÂÆ†Áâ©‰∫íÂä®"],
       
      ["Ê≤°ÊúãÂèã|Á§æ‰∫§ÊÅêÊÉß|‰∏ç‰ºö‰∫§ÈôÖ", 
       "ü´Ç Á§æ‰∫§ÂàÜÊ≠•ÁªÉ‰π†Ôºö\n\n" +
       "‚Ä¢ Èò∂ÊÆµ1ÔºöÊØèÂë®ÂæÆÁ¨ëÈóÆÂÄô3‰∏™ÈôåÁîü‰∫∫\n" +
       "‚Ä¢ Èò∂ÊÆµ2ÔºöÂèÇ‰∏é1Ê¨°Á∫ø‰∏äËÆ®ËÆ∫\n" +
       "‚Ä¢ Èò∂ÊÆµ3ÔºöÂ∞ùËØï15ÂàÜÈíüÁ∫ø‰∏ã‰∫§ÊµÅ"]
    ],
  
    // 6. Áù°Áú†ÈóÆÈ¢ò
    "sleep": [
      ["Â§±Áú†|Áù°‰∏çÁùÄ|ÁÜ¨Â§ú|Áù°‰∏çÂ•Ω", 
       "üåô Áù°Áú†ÊîπÂñÑÊñπÊ°àÔºö\n\n" +
       "1. ÁéØÂ¢ÉË∞ÉÊï¥Ôºö\n" +
       "   ‚Ä¢ ‰ΩøÁî®ÈÅÆÂÖâÁ™óÂ∏ò\n" +
       "   ‚Ä¢ ‰øùÊåÅ18-22‚ÑÉÂÆ§Ê∏©\n" +
       "2. Ë°å‰∏∫ËÆ≠ÁªÉÔºö\n" +
       "   ‚Ä¢ Â∫äÂè™Áî®‰∫éÁù°Áú†Ôºà‰∏çÁé©ÊâãÊú∫Ôºâ\n" +
       "   ‚Ä¢ Âõ∫ÂÆöËµ∑Â∫äÊó∂Èó¥ÔºàÂåÖÊã¨Âë®Êú´Ôºâ"],
       
      ["Â§öÊ¢¶|Âô©Ê¢¶|Áù°‰∏çË∏èÂÆû", 
       "üõå Ê¢¶Â¢ÉÁÆ°ÁêÜÊäÄÂ∑ßÔºö\n\n" +
       "‚Ä¢ Áù°Ââç1Â∞èÊó∂ÈÅøÂÖçÂà∫ÊøÄÂÜÖÂÆπ\n" +
       "‚Ä¢ Âô©Ê¢¶ÂêéÁ´ãÂç≥ÂºÄÁÅØ+ÊîπÂèò‰Ωì‰Ωç\n" +
       "‚Ä¢ ÁªÉ‰π†„ÄåÊ¢¶Â¢ÉÊîπÂÜô„ÄçÔºö\n" +
       "  ÁôΩÂ§©ÊÉ≥Ë±°Âô©Ê¢¶ÂèòÂñúÂâßÁªìÂ±Ä"]
    ],
  
    // 7. ÊÅãÁà±ÂÖ≥Á≥ª
    "relationship": [
      ["ÂàÜÊâã|Â§±ÊÅã|Ë¢´Áî©", 
       "üíî Â§±ÊÅãÊÅ¢Â§çÈò∂ÊÆµÊåáÂçóÔºö\n\n" +
       "Á¨¨1Âë®ÔºöÂÖÅËÆ∏Â¥©Ê∫ÉÔºàËÆæÁΩÆÂèëÊ≥ÑÊó•Ôºâ\n" +
       "Á¨¨2Âë®ÔºöÁâ©ÁêÜÈöîÁ¶ªÔºàÂà†Èô§ËÅîÁ≥ªÊñπÂºèÔºâ\n" +
       "Á¨¨3Âë®ÔºöÈáçÂª∫ÁîüÊ¥ªÔºàÂºÄÂèëÊñ∞‰π†ÊÉØÔºâ"],
       
      ["ÂêµÊû∂|ÂÜ∑Êàò|ÊÑüÊÉÖÂèòÊ∑°", 
       "‚ù§Ô∏è‚Äçü©π ÂÖ≥Á≥ª‰øÆÂ§çÊ≠•È™§Ôºö\n\n" +
       "1. ÊÉÖÁª™ËÆ∞ÂΩïË°®Ôºö\n" +
       "   ËÆ∞ÂΩïÂÜ≤Á™ÅÊó∂ÁöÑË∫´‰ΩìÂèçÂ∫îÔºàÂ¶ÇÂøÉË∑≥Âä†ÈÄüÔºâ\n" +
       "2. ÈùûÊö¥ÂäõÊ≤üÈÄöÔºö\n" +
       "   ËØ¥„ÄåÂΩì...Êó∂ÔºåÊàëÊÑüÂà∞...ÔºåÊàëÈúÄË¶Å...„Äç"]
    ],
  
    // 8. Â∑•‰Ωú/Â≠¶‰∏ö
    "work": [
      ["‰∏çÊÉ≥‰∏äÁè≠|Â∑•‰ΩúÊ≤°ÊÑèÊÄù|ËÅå‰∏öÂÄ¶ÊÄ†", 
       "üíº ËÅå‰∏öÂÄ¶ÊÄ†Â∫îÂØπÔºö\n\n" +
       "‚Ä¢ ÂæÆÂ∞èÊàêÂ∞±ÊÑüÔºö\n" +
       "  ÊØèÂ§©ËÆ∞ÂΩï3‰ª∂ÂÆåÊàêÁöÑÂ∞è‰∫ã\n" +
       "‚Ä¢ Â∑•‰ΩúÊÑè‰πâÈáçÊûÑÔºö\n" +
       "  ÂàóÂá∫Â∑•‰ΩúÂ∏¶Êù•ÁöÑÈó¥Êé•‰ª∑ÂÄº"],
       
      ["ÊãñÂª∂Áóá|‰∏çÊÉ≥Â≠¶‰π†|ÊïàÁéá‰Ωé", 
       "üìö 5ÂàÜÈíüÂêØÂä®Ê≥ïÔºö\n\n" +
       "1. ËÆæÁΩÆ5ÂàÜÈíüÂÄíËÆ°Êó∂\n" +
       "2. Âè™ÂÅöÊúÄÁÆÄÂçïÈÉ®ÂàÜÔºàÂ¶ÇÊâìÂºÄÊñáÊ°£Ôºâ\n" +
       "3. ÂÆåÊàêÂêéÁ´ãÂç≥Â•ñÂä±ÔºàÂ¶ÇÂ∞èÂùóÂ∑ßÂÖãÂäõÔºâ"]
    ],
  
    // 9. Ëá™ÊàëËÆ§Áü•
    "self": [
      ["Ëá™Âçë|ËßâÂæóËá™Â∑±Ê≤°Áî®|‰∏çÂ¶ÇÂà´‰∫∫", 
       "üåü ‰ºòÂäøÂèëÁé∞ÁªÉ‰π†Ôºö\n\n" +
       "1. ÂõûÂøÜËøáÂéª3Ê¨°Ë¢´Áß∞ËµûÁªèÂéÜ\n" +
       "2. ÂÆåÊàêVIAÊÄßÊ†º‰ºòÂäøÊµãËØïÔºàÂÖçË¥πÂú®Á∫øÁâàÔºâ\n" +
       "3. Âª∫Á´ã„Äå‰ºòÁÇπÊó•ËÆ∞„ÄçÊØèÂë®ËÆ∞ÂΩï"],
       
      ["Ëø∑Ëå´|‰∏çÁü•ÈÅìË¶Å‰ªÄ‰πà|Ê≤°ÊúâÁõÆÊ†á", 
       "üß≠ ‰∫∫ÁîüÁΩóÁõòÊé¢Á¥¢Ôºö\n\n" +
       "‚Ä¢ 10Âπ¥ÊÉ≥Ë±°Ê≥ïÔºö\n" +
       "  ÂÜô„ÄåÊàëÂ∏åÊúõ10Âπ¥ÂêéÁöÑÊôÆÈÄö‰∏ÄÂ§©„Äç\n" +
       "‚Ä¢ ÂèçÂêëÊéíÈô§Ê≥ïÔºö\n" +
       "  ÂàóÂá∫ÁªùÂØπ‰∏çÊÉ≥Ë¶ÅÁöÑÁîüÊ¥ªÁä∂ÊÄÅ"]
    ],
  
    // 10. ÂÆ∂Â∫≠ÂÖ≥Á≥ª
    "family": [
      ["Áà∂ÊØç‰∏çÁêÜËß£|Áà∂ÊØçÊ†πÊú¨‰∏çÁêÜËß£|‰ª£Ê≤ü|ÂéüÁîüÂÆ∂Â∫≠", 
       "üë®‚Äçüë©‚Äçüëß ‰ª£ÈôÖÊ≤üÈÄöÊäÄÂ∑ßÔºö\n\n" +
       "1. ÂéÜÂè≤ËÉåÊôØÁêÜËß£Ôºö\n" +
       "   ‰∫ÜËß£Áà∂ÊØçÊàêÈïøÊó∂ÊúüÁöÑ‰ª∑ÂÄºËßÇ\n" +
       "2. ÈùûÂØπÊäóË°®ËææÔºö\n" +
       "   Áî®„ÄåÊàë‰ª¨„Äç‰ª£Êõø„Äå‰Ω†„ÄçÂºÄÂ§¥"],
       
      ["‰∫≤ÊàöÂÇ¨Â©ö|ÂÆ∂Â∫≠ÂéãÂäõ", 
       "üõ° Â∫îÂØπÂÇ¨Â©öÁ≠ñÁï•Ôºö\n\n" +
       "‚Ä¢ Ê†áÂáÜÂ∫îÁ≠îÊ®°ÊùøÔºö\n" +
       "  „ÄåÊ≠£Âú®Âä™Âäõ‰∏≠ÔºåÊúâËøõÂ±ï‰ºöÂëäËØâÂ§ßÂÆ∂„Äç\n" +
       "‚Ä¢ ËØùÈ¢òËΩ¨ÁßªÊäÄÂ∑ßÔºö\n" +
       "  ‰∏ªÂä®ËØ¢ÈóÆÂØπÊñπÂÅ•Â∫∑/ÊóÖÊ∏∏ËÆ°Âàí"]
    ],
  
    // 11. Ë∫Ø‰ΩìÂèçÂ∫î
    "physical": [
      ["ÂøÉÊÖå|ÊâãÊäñ|Âá∫Ê±ó|Ë∫´‰Ωì‰∏çËàíÊúç", 
       "ü©∫ ÊÉÖÁª™Ë∫Ø‰ΩìÂåñÂ∫îÂØπÔºö\n\n" +
       "1. Âå∫ÂàÜÊ£ÄÊü•Ôºö\n" +
       "   ‚Ä¢ ÂÖàÊéíÈô§ÁîüÁêÜÁñæÁóÖÔºà‰ΩìÊ£ÄÔºâ\n" +
       "   ‚Ä¢ ËÆ∞ÂΩïÂèë‰ΩúÊÉÖÂ¢ÉÔºàÊÉÖÁª™Êó•ËÆ∞Ôºâ\n" +
       "2. ÁºìËß£ÊäÄÂ∑ßÔºö\n" +
       "   ‚Ä¢ ÂèåÊâãÊµ∏ÂÖ•Ê∏©Ê∞¥40Áßí"],
       
      ["Ê≤°ËÉÉÂè£|Êö¥È£ü|È•ÆÈ£üÂ§±Ë∞É", 
       "üçΩ ÊÉÖÁª™ÂåñÈ•ÆÈ£üÁÆ°ÁêÜÔºö\n\n" +
       "‚Ä¢ È••È•øÊÑüÈáèË°®Ôºà1-10ÂàÜËØÑ‰º∞Ôºâ\n" +
       "‚Ä¢ Êõø‰ª£Ë°å‰∏∫Ê∏ÖÂçïÔºö\n" +
       "  ÊÉÖÁª™ÊøÄÂä®Êó∂ÂÖàÂÅöÂàóË°®ÂÖ∂‰ªñ‰∫ãÔºàÂ¶ÇÊãºÂõæÔºâ"]
    ],
  
    // 12. ÁâπÊÆäÊÉÖÂ¢É
    "special": [
      ["Áñ´ÊÉÖ|ÈöîÁ¶ª|Â∞ÅÊéß", 
       "üò∑ ÈöîÁ¶ªÊúüÂøÉÁêÜÁª¥Êä§Ôºö\n\n" +
       "‚Ä¢ Âª∫Á´ãÁîüÊ¥ªÈîöÁÇπÔºö\n" +
       "  Âõ∫ÂÆöÊó∂Èó¥ÂÅöÂõ∫ÂÆö‰∫ãÔºàÂ¶ÇÊô®Èó¥ÂíñÂï°Ôºâ\n" +
       "‚Ä¢ ÊúâÈôê‰ø°ÊÅØÊé•Ëß¶Ôºö\n" +
       "  ÊØèÂ§©Âè™Áúã2Ê¨°ÊùÉÂ®ÅÁñ´ÊÉÖÈÄöÊä•"],
       
      ["Â§±‰∏ö|Ë¢´Ë£ÅÂëò|ÊâæÂ∑•‰ΩúÈöæ", 
       "üíº ËÅå‰∏öËøáÊ∏°ÊúüÊåáÂçóÔºö\n\n" +
       "1. ÁªèÊµéËßÑÂàíÔºö\n" +
       "   ‚Ä¢ ËÆ°ÁÆóÁîüÂ≠òËµÑÈáëÂ∫ïÁ∫ø\n" +
       "2. ÊäÄËÉΩÊèêÂçáÔºö\n" +
       "   ‚Ä¢ ÊØèÂ§©2Â∞èÊó∂Âú®Á∫øÂ≠¶‰π†\n" +
       "3. ‰∫∫ËÑâÊøÄÊ¥ªÔºö\n" +
       "   ‚Ä¢ ÊØèÂë®ËÅîÁ≥ª3‰∏™ÂâçÂêå‰∫ã"]
    ],
  
    // ÈªòËÆ§ÂõûÂ§çÔºàÂΩìÊó†ÂåπÈÖçÊó∂Ôºâ
    "default": "Ê≠£Âú®‰∏∫ÊÇ®Ê∑±Â∫¶ÂàÜÊûêÊÉÖÁª™...\n\nüí° ÊÇ®ÂèØ‰ª•ÂÖàÂ∞ùËØïÔºö\n‚Ä¢ Ê∑±ÂëºÂê∏‰∏âÊ¨°\n‚Ä¢ ÂñùÂçäÊùØÊ∏©Ê∞¥\n‚Ä¢ ËÆ∞ÂΩïÊ≠§ÂàªÊÑüÂèó"
  },

  data: {
    messages: [],
    inputValue: '',
    isSending: false,
    scrollTop: 0,
    userAvatar: '',
    apiError: false
  },

  onLoad: function() {
    this.getUserAvatar();
    this.addWelcomeMessage();
  },

  onShow: function() {
    this.getUserAvatar();
  },

  getUserAvatar: function() {
    const userInfo = wx.getStorageSync('userInfo');
    if (userInfo?.avatarUrl) {
      this.setData({ userAvatar: userInfo.avatarUrl });
    }
  },

  onInput: function(e) {
    this.setData({ inputValue: e.detail.value });
  },

  // ‰øÆÊîπÂêéÁöÑÂèëÈÄÅÈÄªËæë
  sendMessage: function() {
    const content = this.data.inputValue.trim();
    if (!content || this.data.isSending) return;

    this.addUserMessage(content);
    this.setData({ inputValue: '', isSending: true });

    // ÂÖàÂ∞ùËØïÊú¨Âú∞ÂåπÈÖç
    const localReply = this.matchLocalKnowledge(content);
    if (localReply !== this.localKnowledgeBase.default) {
      setTimeout(() => {
        this.addBotMessage(localReply, true);
        this.setData({ isSending: false });
      }, 600); // Ê®°ÊãüÊÄùËÄÉÊó∂Èó¥
    } else {
      // Â§çÊùÇÈóÆÈ¢òË∞ÉÁî®API
      this.callDeepseekApi(content);
    }
  },

  // Êñ∞Â¢ûÔºöÊú¨Âú∞Áü•ËØÜÂåπÈÖç
  matchLocalKnowledge: function(text) {
    const kb = this.localKnowledgeBase;
    text = text.toLowerCase();
    
    // ‰ºòÂÖàÁ∫ßÂåπÈÖç
    for (const [keyword, rules] of Object.entries(kb)) {
      if (keyword === "default") continue;
      
      for (const [pattern, reply] of rules) {
        const regex = new RegExp(pattern, "i");
        if (regex.test(text)) {
          return reply;
        }
      }
    }
    return kb.default;
  },

  // ‰øÆÊîπÂêéÁöÑAPIË∞ÉÁî®
  callDeepseekApi: function(content) {
    const thinkingId = this.addThinkingMessage();

    wx.cloud.callFunction({
      name: 'deepseekchat',
      data: { text: content },
      success: res => {
        this.removeThinkingMessage(thinkingId);
        if (res.result?.reply) {
          this.addBotMessage(res.result.reply, true);
        } else {
          this.showAPIError("ÂàÜÊûêÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
        }
      },
      fail: err => {
        this.removeThinkingMessage(thinkingId);
        console.error("APIË∞ÉÁî®Â§±Ë¥•:", err);
        this.showAPIError("ÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®");
        
        // APIÂ§±Ë¥•Êó∂Â∞ùËØïËøîÂõûÊú¨Âú∞ÂÖúÂ∫ïÂõûÁ≠î
        const fallbackReply = this.getFallbackReply(content);
        this.addBotMessage(fallbackReply, true);
      },
      complete: () => {
        this.setData({ isSending: false });
      }
    });
  },

  // Êñ∞Â¢ûÔºöAPIÂ§±Ë¥•Êó∂ÁöÑÂÖúÂ∫ïÂõûÂ§ç
  getFallbackReply: function(text) {
    const kb = this.localKnowledgeBase;
    for (const [keyword, rules] of Object.entries(kb)) {
      if (keyword === "default") continue;
      for (const [pattern] of rules) {
        if (new RegExp(pattern, "i").test(text)) {
          return "ÁΩëÁªú‰∏çÁ®≥ÂÆöÔºå‰ΩÜÊ£ÄÊµãÂà∞ÊÇ®ÂèØËÉΩÈúÄË¶ÅÔºö\n" + 
                 rules.find(r => r[0] === pattern)[1];
        }
      }
    }
    return "ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏ÔºåËØ∑Á®çÂêéÂÜçËØï\nÊÇ®ÂèØ‰ª•ÂÖàËØïËØïÔºö\n1. Ê∑±ÂëºÂê∏ÊîæÊùæ\n2. ËÆ∞ÂΩïÂΩìÂâçÊÑüÂèó";
  },

  // ‰ª•‰∏ã‰øùÊåÅÂéüÊúâÊ∂àÊÅØÁÆ°ÁêÜÊñπÊ≥ï‰∏çÂèò
  addWelcomeMessage: function() {
    this.addMessage({
      role: 'assistant',
      content: 'ÊÇ®Â•ΩÔºåÊàëÊòØÊÉÖÊÑüÂàÜÊûêÂä©Êâã„ÄÇÁÆÄÂçïÈóÆÈ¢òÊàë‰ºöÂø´ÈÄüÂõûÂ§çÔºåÂ§çÊùÇÈóÆÈ¢òÂ∞ÜÊ∑±Â∫¶ÂàÜÊûê„ÄÇ',
      time: this.formatTime(new Date()),
      id: Date.now()
    });
  },

  addUserMessage: function(content) {
    this.addMessage({
      role: 'user',
      content: content,
      time: this.formatTime(new Date()),
      id: Date.now()
    });
  },

  addBotMessage: function(content, isAnalysis = false) {
    this.addMessage({
      role: 'assistant',
      content: content,
      time: this.formatTime(new Date()),
      id: Date.now(),
      isAnalysisResult: isAnalysis
    });
  },

  addThinkingMessage: function() {
    const id = 'thinking_' + Date.now();
    this.addMessage({
      role: 'assistant',
      content: 'Ê≠£Âú®ÂàÜÊûê‰∏≠...',
      time: this.formatTime(new Date()),
      id: id,
      isThinking: true
    });
    return id;
  },

  removeThinkingMessage: function(id) {
    this.setData({
      messages: this.data.messages.filter(msg => msg.id !== id)
    });
  },

  addMessage: function(message) {
    this.setData({
      messages: [...this.data.messages, message]
    }, this.scrollToBottom);
  },

  scrollToBottom: function() {
    this.setData({ scrollTop: 999999 });
  },

  showAPIError: function(message) {
    this.addMessage({
      role: 'assistant',
      content: `‚ö†Ô∏è ${message}`,
      time: this.formatTime(new Date()),
      id: Date.now()
    });
    this.setData({ apiError: true });
  },

  formatTime: function(date) {
    return date.toTimeString().substr(0, 5);
  }
});